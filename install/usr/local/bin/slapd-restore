#!/command/with-contenv bash

source /assets/functions/00-container
source /assets/defaults/10-openldap

# Usage: /usr/local/bin/slapd-restore dbnum file
dbnum=$1
ldif_file=$2

if [ -z "${1}" ] ; then
    echo "Syntax: $(basename "$0") dbnum[0|1] [filename]"
    exit 2
elif [ -z "${2}" ] ; then
    echo "Need Filename to restore!"
    exit 2
fi

# stop slapd
s6-svc -d /var/run/s6/legacy-services/10-openldap
pkill slapd

tmp_backup_file="$(mktemp)"
case "${ldif_file##*.}" in
    gz )
        gunzip -c "$ldif_file" > "${tmp_backup_file}"
    ;;
    zst )
        zstd -d "$file" > "${tmp_backup_file}"
    ;;
esac

chown ldap:ldap "${tmp_backup_file}"

case "$1" in
    0 )
        tmp_docker_files="$(mktemp -d)"
        mv "${CONFIG_PATH}"/docker-* "${tmp_docker_files}"/
        rm -rf "${CONFIG_PATH}"/slap.d/*
    ;;
    1 )
        rm -rf "${DB_PATH:?}"/*
    ;;
esac

sudo -u ldap slapadd -v -F /etc/openldap/slapd.d -n "${dbnum}" -l "${tmp_backup_file}"

case "$1" in
    0 )
        mv "${tmp_docker_files}"/* "${CONFIG_PATH}"/
        rm -rf "${tmp_docker_files}"
    ;;
esac

# restart slapd
s6-svc -u /var/run/s6/legacy-services/10-openldap

rm -rf  "${tmp_backup_file}"
exit 0
